{% extends "base.html" %}

{% block title %}{{ form_obj.title }} - 信息收集系统{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- 表单头部 -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-lg mb-4">
                <div class="card-header bg-primary text-white py-4">
                    <div class="text-center">
                        <h2 class="mb-2">{{ form_obj.title }}</h2>
                        {% if form_obj.description %}
                            <p class="mb-0 opacity-75">{{ form_obj.description }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-5">
                    <form method="POST" enctype="multipart/form-data" id="dynamicForm">
                        {{ form.hidden_tag() }}
                        
                        {% for field in form_obj.fields|sort(attribute='order_index') %}
                            <div class="mb-4">
                                {% set form_field = form[field.field_name] %}
                                
                                <!-- 字段标签 -->
                                <label for="{{ field.field_name }}" class="form-label fw-bold">
                                    {{ field.field_label }}
                                    {% if field.is_required %}
                                        <span class="text-danger">*</span>
                                    {% endif %}
                                </label>
                                
                                <!-- 根据字段类型渲染不同的输入控件 -->
                                {% if field.field_type == 'text' or field.field_type == 'email' or field.field_type == 'tel' %}
                                    {{ form_field(class="form-control form-control-lg", placeholder=field.placeholder or '') }}
                                
                                {% elif field.field_type == 'textarea' %}
                                    {{ form_field(class="form-control", rows="4", placeholder=field.placeholder or '') }}
                                
                                {% elif field.field_type == 'number' %}
                                    {{ form_field(class="form-control form-control-lg", placeholder=field.placeholder or '') }}
                                
                                {% elif field.field_type == 'select' %}
                                    {{ form_field(class="form-select form-select-lg") }}
                                
                                {% elif field.field_type == 'radio' %}
                                    {% for option in field.get_options() %}
                                        <div class="form-check">
                                            {{ form_field(class="form-check-input", id=field.field_name + "_" + loop.index|string, value=option) }}
                                            <label class="form-check-label" for="{{ field.field_name }}_{{ loop.index }}">
                                                {{ option }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                
                                {% elif field.field_type == 'checkbox' %}
                                    {% for option in field.get_options() %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="{{ field.field_name }}" 
                                                   value="{{ option }}" 
                                                   id="{{ field.field_name }}_{{ loop.index }}">
                                            <label class="form-check-label" for="{{ field.field_name }}_{{ loop.index }}">
                                                {{ option }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                
                                {% elif field.field_type == 'file' %}
                                    <div class="file-upload-area">
                                        {{ form_field(class="form-control form-control-lg", accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.mp4,.avi,.mov") }}
                                        <div class="file-upload-hint mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                支持格式：图片(jpg, png, gif)、文档(pdf, doc, docx)、视频(mp4, avi, mov)，最大100MB
                                            </small>
                                        </div>
                                        <div class="file-preview mt-2" id="preview_{{ field.field_name }}" style="display: none;">
                                            <div class="alert alert-info">
                                                <i class="fas fa-file me-2"></i>
                                                <span class="file-name"></span>
                                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearFile('{{ field.field_name }}')">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                
                                {% elif field.field_type == 'date' %}
                                    {{ form_field(class="form-control form-control-lg", type="date") }}
                                
                                {% elif field.field_type in ['wechat_pay', 'alipay'] %}
                                    <div class="payment-field">
                                        <div class="payment-header mb-3">
                                            <div class="payment-icon">
                                                {% if field.field_type == 'wechat_pay' %}
                                                    <i class="fab fa-weixin text-success" style="font-size: 2rem;"></i>
                                                    <span class="payment-label">微信支付</span>
                                                {% else %}
                                                    <i class="fab fa-alipay text-primary" style="font-size: 2rem;"></i>
                                                    <span class="payment-label">支付宝支付</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text">¥</span>
                                            {{ form_field(class="form-control", placeholder="请输入支付金额", step="0.01", min="0.01") }}
                                            <span class="input-group-text">元</span>
                                        </div>
                                        <div class="payment-note mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                提交表单后将跳转到支付页面完成付款
                                            </small>
                                        </div>
                                    </div>
                                
                                {% else %}
                                    {{ form_field(class="form-control form-control-lg", placeholder=field.placeholder or '') }}
                                {% endif %}
                                
                                <!-- 字段错误信息 -->
                                {% if form_field.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form_field.errors %}
                                            <small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                        
                        <!-- 提交按钮 -->
                        <div class="text-center mt-5">
                            <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                                <i class="fas fa-paper-plane me-2"></i>提交表单
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.file-upload-area {
    position: relative;
}

.file-upload-hint {
    border: 2px dashed #e9ecef;
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    background-color: #f8f9fa;
}

.form-check {
    padding: 0.5rem 0;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.card {
    overflow: hidden;
}

.required-field {
    border-left: 4px solid #dc3545;
}

.optional-field {
    border-left: 4px solid #28a745;
}

.payment-field {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    border: 2px solid #e9ecef;
}

.payment-header {
    text-align: center;
}

.payment-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.payment-label {
    font-size: 1.1rem;
    font-weight: 600;
    color: #495057;
}

.payment-note {
    text-align: center;
}
</style>

<script>
// 文件上传预览
document.querySelectorAll('input[type="file"]').forEach(function(input) {
    input.addEventListener('change', function() {
        const fieldName = this.name;
        const preview = document.getElementById('preview_' + fieldName);
        const fileName = preview.querySelector('.file-name');
        
        if (this.files.length > 0) {
            fileName.textContent = this.files[0].name;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    });
});

// 清除文件
function clearFile(fieldName) {
    const input = document.querySelector('input[name="' + fieldName + '"]');
    const preview = document.getElementById('preview_' + fieldName);
    
    input.value = '';
    preview.style.display = 'none';
}

// 表单提交确认
document.getElementById('dynamicForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>提交中...';
    
    // 如果有文件上传，显示上传进度
    const fileInputs = this.querySelectorAll('input[type="file"]');
    let hasFiles = false;
    fileInputs.forEach(function(input) {
        if (input.files.length > 0) {
            hasFiles = true;
        }
    });
    
    if (hasFiles) {
        // 模拟上传进度
        let progress = 0;
        const progressInterval = setInterval(function() {
            progress += 10;
            submitBtn.innerHTML = `<i class="fas fa-cloud-upload-alt me-2"></i>上传中... ${progress}%`;
            if (progress >= 100) {
                clearInterval(progressInterval);
                submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>提交完成';
            }
        }, 200);
    }
});

// 必填字段验证
document.querySelectorAll('input[required], select[required], textarea[required]').forEach(function(field) {
    field.addEventListener('blur', function() {
        if (this.value.trim() === '') {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });
});
</script>
{% endblock %}
