{% extends "base.html" %}

{% block title %}{{ form.title }} - æäº¤è®°å½•{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <a href="{{ url_for('admin_forms') }}" class="btn btn-outline-secondary me-3">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div>
                        <h2 class="mb-1">{{ form.title }}</h2>
                        <p class="text-muted mb-0">
                            <i class="fas fa-paper-plane me-1"></i>æäº¤è®°å½• ({{ submissions|length }}) | 
                            <i class="fas fa-calendar me-1"></i>åˆ›å»ºäº {{ form.created_at | local_date }}
                        </p>
                    </div>
                </div>
                <div>
                    <a href="{{ url_for('view_form', form_id=form.id) }}" 
                       class="btn btn-outline-success" target="_blank">
                        <i class="fas fa-external-link-alt me-2"></i>é¢„è§ˆè¡¨å•
                    </a>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                        <i class="fas fa-download me-2"></i>å¯¼å‡ºæ•°æ®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-primary mb-2">
                        <i class="fas fa-file-alt text-white"></i>
                    </div>
                    <h4 class="fw-bold text-primary">{{ submissions|length }}</h4>
                    <p class="text-muted mb-0">æ€»æäº¤æ•°</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-warning mb-2">
                        <i class="fas fa-clock text-white"></i>
                    </div>
                    <h4 class="fw-bold text-warning">{{ submissions|selectattr('status', 'equalto', 'submitted')|list|length }}</h4>
                    <p class="text-muted mb-0">å¾…å®¡æ ¸</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-success mb-2">
                        <i class="fas fa-check-circle text-white"></i>
                    </div>
                    <h4 class="fw-bold text-success">{{ submissions|selectattr('status', 'equalto', 'approved')|list|length }}</h4>
                    <p class="text-muted mb-0">å·²é€šè¿‡</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-danger mb-2">
                        <i class="fas fa-times-circle text-white"></i>
                    </div>
                    <h4 class="fw-bold text-danger">{{ submissions|selectattr('status', 'equalto', 'rejected')|list|length }}</h4>
                    <p class="text-muted mb-0">å·²æ‹’ç»</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æäº¤è®°å½•åˆ—è¡¨ -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-list me-2"></i>æäº¤è®°å½•
                </h5>
                <div class="d-flex align-items-center">
                    <!-- çŠ¶æ€ç­›é€‰ -->
                    <select class="form-select form-select-sm me-3" id="statusFilter" onchange="filterByStatus()">
                        <option value="">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="submitted">å¾…å®¡æ ¸</option>
                        <option value="approved">å·²é€šè¿‡</option>
                        <option value="rejected">å·²æ‹’ç»</option>
                    </select>
                    <!-- æœç´¢æ¡† -->
                    <div class="input-group input-group-sm" style="width: 200px;">
                        <input type="text" class="form-control" placeholder="æœç´¢ç”¨æˆ·..." id="searchInput" onkeyup="searchSubmissions()">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
            <div class="batch-actions-toolbar mb-3" id="batchActionsToolbar" style="display: none;">
                <div class="alert alert-info d-flex justify-content-between align-items-center mb-0">
                    <div>
                        <i class="fas fa-check-square me-2"></i>
                        å·²é€‰ä¸­ <span id="selectedCount">0</span> ä¸ªæäº¤è®°å½•
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-danger" onclick="batchDeleteSubmissions()">
                            <i class="fas fa-trash me-1"></i>æ‰¹é‡åˆ é™¤
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearSelection()">
                            <i class="fas fa-times me-1"></i>å–æ¶ˆé€‰æ‹©
                        </button>
                    </div>
                </div>
            </div>
            
            {% if submissions %}
                <div class="table-responsive">
                    <table class="table table-hover" id="submissionsTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 3%;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th style="width: 5%;">ID</th>
                                <th style="width: 15%;">æäº¤è€…</th>
                                <th style="width: 15%;">è”ç³»æ–¹å¼</th>
                                <th style="width: 15%;">æäº¤æ—¶é—´</th>
                                <th style="width: 10%;">çŠ¶æ€</th>
                                <th style="width: 22%;">æäº¤å†…å®¹æ‘˜è¦</th>
                                <th style="width: 15%;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for submission in submissions %}
                            <tr data-status="{{ submission.status }}">
                                <td>
                                    <input type="checkbox" class="submission-checkbox" value="{{ submission.id }}" onchange="updateBatchActions()">
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">#{{ submission.id }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar bg-primary text-white rounded-circle me-2">
                                            {{ submission.user.name[0].upper() }}
                                        </div>
                                        <strong>{{ submission.user.name }}</strong>
                                    </div>
                                </td>
                                <td class="user-contact">
                                    {% if submission.user.email %}
                                        <small class="text-muted d-block">
                                            <i class="fas fa-envelope me-1"></i>{{ submission.user.email }}
                                        </small>
                                    {% endif %}
                                    {% if submission.user.phone %}
                                        <small class="text-muted d-block">
                                            <i class="fas fa-phone me-1"></i>{{ submission.user.phone }}
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-muted">{{ submission.submitted_at | local_date }}</span>
                                    <br><small class="text-muted">{{ submission.submitted_at | local_time('%H:%M:%S') }}</small>
                                </td>
                                <td>
                                    {% if submission.status == 'submitted' %}
                                        <span class="badge bg-warning">å¾…å®¡æ ¸</span>
                                    {% elif submission.status == 'approved' %}
                                        <span class="badge bg-success">å·²é€šè¿‡</span>
                                    {% elif submission.status == 'rejected' %}
                                        <span class="badge bg-danger">å·²æ‹’ç»</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ submission.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set data_dict = submission.get_data_dict() %}
                                    <small class="text-muted">
                                        {% for field in form.fields[:3] %}
                                            {% set value = data_dict.get(field.field_name, '') %}
                                            {% if value %}
                                                <strong>{{ field.field_label }}:</strong> 
                                                {% if value|length > 20 %}
                                                    {{ value[:20] }}...
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                                <br>
                                            {% endif %}
                                        {% endfor %}
                                        {% if submission.files %}
                                            <i class="fas fa-paperclip text-primary"></i> {{ submission.files|length }}ä¸ªé™„ä»¶
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('view_submission', submission_id=submission.id) }}" 
                                           class="btn btn-outline-primary" target="_blank" title="æŸ¥çœ‹è¯¦æƒ…">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if submission.status == 'submitted' %}
                                            <button class="btn btn-outline-success" 
                                                    onclick="updateStatus({{ submission.id }}, 'approved')" 
                                                    title="é€šè¿‡">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" 
                                                    onclick="updateStatus({{ submission.id }}, 'rejected')" 
                                                    title="æ‹’ç»">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteSubmission({{ submission.id }}, '{{ submission.user.name }}')" 
                                                title="åˆ é™¤æäº¤">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox text-muted" style="font-size: 4rem;"></i>
                    <h5 class="text-muted mt-3">æš‚æ— æäº¤è®°å½•</h5>
                    <p class="text-muted">å½“ç”¨æˆ·å¡«å†™å¹¶æäº¤è¡¨å•åï¼Œè®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                    <a href="{{ url_for('view_form', form_id=form.id) }}" 
                       class="btn btn-primary mt-2" target="_blank">
                        <i class="fas fa-external-link-alt me-2"></i>å»å¡«å†™è¡¨å•
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin: 0 auto;
}

.user-avatar {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: bold;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
    vertical-align: middle;
}

.table td {
    vertical-align: middle;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}

.badge {
    font-size: 0.75rem;
}

.status-filter-active {
    background-color: #e3f2fd;
}

/* æ‰¹é‡æ“ä½œå·¥å…·æ æ ·å¼ */
.batch-actions-toolbar .alert {
    border-radius: 8px;
    border: 1px solid #bee5eb;
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.batch-actions-toolbar .btn {
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.batch-actions-toolbar .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* å¤é€‰æ¡†æ ·å¼ */
input[type="checkbox"] {
    transform: scale(1.1);
    cursor: pointer;
}

input[type="checkbox"]:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* è¡¨æ ¼è¡Œé€‰ä¸­æ•ˆæœ */
tr.selected {
    background-color: #e3f2fd !important;
}

/* åŠ¨ç”»æ•ˆæœ */
.fade-out {
    opacity: 0.5 !important;
    transform: translateX(-100%) !important;
    transition: all 0.3s ease !important;
}
</style>

<script>
// æŒ‰çŠ¶æ€ç­›é€‰
function filterByStatus() {
    const filter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#submissionsTable tbody tr');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        if (filter === '' || status === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// æœç´¢æäº¤è®°å½•
function searchSubmissions() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#submissionsTable tbody tr');
    
    rows.forEach(row => {
        const userName = row.cells[1].textContent.toLowerCase();
        const userContact = row.cells[2].textContent.toLowerCase();
        const content = row.cells[5].textContent.toLowerCase();
        
        if (userName.includes(searchTerm) || userContact.includes(searchTerm) || content.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// æ›´æ–°æäº¤çŠ¶æ€
function updateStatus(submissionId, newStatus) {
    const statusText = newStatus === 'approved' ? 'é€šè¿‡' : 'æ‹’ç»';
    if (confirm(`ç¡®å®šè¦${statusText}è¿™ä¸ªæäº¤å—ï¼Ÿ`)) {
        // è·å–å½“å‰è¡Œçš„æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const buttons = document.querySelectorAll(`[onclick*="updateStatus(${submissionId}"]`);
        buttons.forEach(btn => {
            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.originalHtml = originalHtml;
        });
        
        // å‘é€è¯·æ±‚åˆ°åç«¯æ›´æ–°çŠ¶æ€
        fetch(`/admin/submissions/${submissionId}/update-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                const rows = document.querySelectorAll('#submissionsTable tbody tr');
                let targetRow = null;
                
                // æŸ¥æ‰¾åŒ…å«æŒ‡å®šæäº¤IDçš„è¡Œ
                rows.forEach(row => {
                    const idBadge = row.querySelector('.badge');
                    if (idBadge && idBadge.textContent.includes(`#${submissionId}`)) {
                        targetRow = row;
                    }
                });
                
                if (targetRow) {
                    // æ›´æ–°è¡Œçš„data-statuså±æ€§
                    targetRow.setAttribute('data-status', newStatus);
                    
                    // æ›´æ–°çŠ¶æ€å¾½ç« 
                    const statusCell = targetRow.cells[5]; // çŠ¶æ€åˆ—
                    let badgeClass = 'bg-secondary';
                    if (newStatus === 'approved') badgeClass = 'bg-success';
                    else if (newStatus === 'rejected') badgeClass = 'bg-danger';
                    else if (newStatus === 'submitted') badgeClass = 'bg-warning';
                    
                    statusCell.innerHTML = `<span class="badge ${badgeClass}">${data.status_text}</span>`;
                    
                    // æ›´æ–°æ“ä½œæŒ‰é’®
                    const actionCell = targetRow.cells[7]; // æ“ä½œåˆ—
                    if (newStatus === 'approved' || newStatus === 'rejected') {
                        // ç§»é™¤å®¡æ ¸æŒ‰é’®ï¼Œä¿ç•™æŸ¥çœ‹å’Œåˆ é™¤æŒ‰é’®
                        const viewBtn = actionCell.querySelector('.btn-outline-primary');
                        const deleteBtn = actionCell.querySelector('.btn-outline-danger');
                        if (viewBtn && deleteBtn) {
                            actionCell.innerHTML = '<div class="btn-group btn-group-sm">' + viewBtn.outerHTML + deleteBtn.outerHTML + '</div>';
                        }
                    }
                }
                
                // æ›´æ–°ç»Ÿè®¡æ•°å­—
                updateStatistics();
            } else {
                throw new Error(data.error || 'çŠ¶æ€æ›´æ–°å¤±è´¥');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast(error.message || 'çŠ¶æ€æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = btn.originalHtml || btn.innerHTML;
            });
        });
    }
}

// åˆ é™¤å•ä¸ªæäº¤è®°å½•
function deleteSubmission(submissionId, userName) {
    // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
    document.getElementById('deleteConfirmText').innerHTML = 
        `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· <strong>"${userName}"</strong> çš„è¿™ä¸ªæäº¤è®°å½•å—ï¼Ÿ`;
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
    
    // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.getElementById('confirmDeleteBtn').onclick = function() {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>åˆ é™¤ä¸­...';
        btn.disabled = true;
        
        // å‘é€åˆ é™¤è¯·æ±‚
        fetch(`/admin/submissions/${submissionId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // å…³é—­æ¨¡æ€æ¡†
                modal.hide();
                
                showToast(data.message, 'success');
                
                // ä»è¡¨æ ¼ä¸­ç§»é™¤è¯¥è¡Œ
                const rows = document.querySelectorAll('#submissionsTable tbody tr');
                rows.forEach(row => {
                    const idBadge = row.querySelector('.badge');
                    if (idBadge && idBadge.textContent.includes(`#${submissionId}`)) {
                        row.style.opacity = '0.5';
                        row.style.transform = 'translateX(-100%)';
                        setTimeout(() => {
                            row.remove();
                            // æ›´æ–°ç»Ÿè®¡æ•°å­—
                            updateStatistics();
                            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æäº¤è®°å½•
                            checkEmptyTable();
                        }, 300);
                    }
                });
                
            } else {
                throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast(error.message || 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    };
}

// æ‰¹é‡é€‰æ‹©åŠŸèƒ½
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const submissionCheckboxes = document.querySelectorAll('.submission-checkbox');
    
    submissionCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateBatchActions();
}

function updateBatchActions() {
    const selectedCheckboxes = document.querySelectorAll('.submission-checkbox:checked');
    const batchToolbar = document.getElementById('batchActionsToolbar');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedCheckboxes.length > 0) {
        batchToolbar.style.display = 'block';
        selectedCount.textContent = selectedCheckboxes.length;
    } else {
        batchToolbar.style.display = 'none';
    }
    
    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
    const selectAllCheckbox = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('.submission-checkbox');
    if (selectedCheckboxes.length === allCheckboxes.length && allCheckboxes.length > 0) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else if (selectedCheckboxes.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
}

function clearSelection() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const submissionCheckboxes = document.querySelectorAll('.submission-checkbox');
    
    selectAllCheckbox.checked = false;
    submissionCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    updateBatchActions();
}

// æ‰¹é‡åˆ é™¤æäº¤è®°å½•
function batchDeleteSubmissions() {
    const selectedCheckboxes = document.querySelectorAll('.submission-checkbox:checked');
    const submissionIds = Array.from(selectedCheckboxes).map(checkbox => parseInt(checkbox.value));
    
    if (submissionIds.length === 0) {
        showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æäº¤è®°å½•', 'warning');
        return;
    }
    
    if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™ ${submissionIds.length} ä¸ªæäº¤è®°å½•å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤åæ— æ³•æ¢å¤ï¼Œç›¸å…³çš„ä¸Šä¼ æ–‡ä»¶ä¹Ÿä¼šè¢«åˆ é™¤ã€‚`)) {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const deleteButton = document.querySelector('[onclick="batchDeleteSubmissions()"]');
        if (deleteButton) {
            const originalHtml = deleteButton.innerHTML;
            deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>åˆ é™¤ä¸­...';
            deleteButton.disabled = true;
            deleteButton.originalHtml = originalHtml;
        }
        
        // å‘é€æ‰¹é‡åˆ é™¤è¯·æ±‚
        fetch('/admin/submissions/batch-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                submission_ids: submissionIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                
                // ä»è¡¨æ ¼ä¸­ç§»é™¤é€‰ä¸­çš„è¡Œ
                selectedCheckboxes.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        row.style.opacity = '0.5';
                        row.style.transform = 'translateX(-100%)';
                        setTimeout(() => {
                            row.remove();
                        }, 300);
                    }
                });
                
                // æ¸…é™¤é€‰æ‹©çŠ¶æ€
                setTimeout(() => {
                    clearSelection();
                    updateStatistics();
                    checkEmptyTable();
                }, 500);
                
            } else {
                throw new Error(data.error || 'æ‰¹é‡åˆ é™¤å¤±è´¥');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast(error.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            if (deleteButton) {
                deleteButton.disabled = false;
                deleteButton.innerHTML = deleteButton.originalHtml || deleteButton.innerHTML;
            }
        });
    }
}

// æ£€æŸ¥è¡¨æ ¼æ˜¯å¦ä¸ºç©º
function checkEmptyTable() {
    const tableRows = document.querySelectorAll('#submissionsTable tbody tr');
    if (tableRows.length === 0) {
        // å¦‚æœè¡¨æ ¼ä¸ºç©ºï¼Œåˆ·æ–°é¡µé¢æ˜¾ç¤ºç©ºçŠ¶æ€
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
}

// æ›´æ–°ç»Ÿè®¡æ•°å­—
function updateStatistics() {
    const rows = document.querySelectorAll('#submissionsTable tbody tr');
    let submitted = 0, approved = 0, rejected = 0;
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        if (status === 'submitted') submitted++;
        else if (status === 'approved') approved++;
        else if (status === 'rejected') rejected++;
    });
    
    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
    const statCards = document.querySelectorAll('.stat-icon');
    if (statCards.length >= 4) {
        statCards[1].parentElement.querySelector('h4').textContent = submitted;
        statCards[2].parentElement.querySelector('h4').textContent = approved;
        statCards[3].parentElement.querySelector('h4').textContent = rejected;
    }
}

// æ–°çš„è¡¨å•æäº¤æ•°æ®å¯¼å‡ºå‡½æ•°ï¼Œæ”¯æŒå¯é€‰ä¿å­˜ä½ç½®å’Œæ ¼å¼
function startSubmissionExport() {
    try {
        console.log('ğŸš€ å¼€å§‹å¯¼å‡ºè¡¨å•æäº¤æ•°æ®');
        
        // è·å–è¡¨å•æ•°æ®
        const fileName = document.getElementById('submissionFileName').value.trim() || `${document.title}_submissions`;
        const format = document.querySelector('input[name="submissionExportFormat"]:checked').value;
        
        // è·å–å¯¼å‡ºå†…å®¹é€‰é¡¹
        const includeSubmitterInfo = document.getElementById('includeSubmitterInfo').checked;
        const includeSubmissionTime = document.getElementById('includeSubmissionTime').checked;
        const includeFormData = document.getElementById('includeFormData').checked;
        const includeAttachments = document.getElementById('includeAttachments').checked;
        
        // è·å–çŠ¶æ€ç­›é€‰
        const statusFilter = document.getElementById('exportSubmissionStatusFilter').value;
        
        console.log('ğŸ“‹ å¯¼å‡ºå‚æ•°:', { fileName, format, statusFilter });
        
        // å…³é—­æ¨¡æ€æ¡† - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ï¼Œé¿å… aria-hidden é—®é¢˜
        try {
            const modalElement = document.getElementById('exportModal');
            if (modalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    // å…ˆç§»é™¤ç„¦ç‚¹ï¼Œå†å…³é—­æ¨¡æ€æ¡†
                    const focusedElement = document.activeElement;
                    if (focusedElement && modalElement.contains(focusedElement)) {
                        focusedElement.blur();
                    }
                    modal.hide();
                    console.log('âœ… æ¨¡æ€æ¡†å·²å…³é—­');
                } else {
                    // å¦‚æœå®ä¾‹ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨å…³é—­æ¨¡æ€æ¡†
                    modalElement.style.display = 'none';
                    modalElement.removeAttribute('aria-hidden'); // ç§»é™¤ aria-hidden
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                    console.log('âœ… æ‰‹åŠ¨å…³é—­æ¨¡æ€æ¡†');
                }
            }
        } catch (modalError) {
            console.warn('âš ï¸ å…³é—­æ¨¡æ€æ¡†æ—¶å‡ºé”™:', modalError);
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€çš„Toast
        showToast('æ­£åœ¨å‡†å¤‡å¯¼å‡ºæ•°æ®ï¼Œè¯·ç¨å€™...', 'info');
        
        // è·å–è¡¨å•ID
        const formId = window.location.pathname.split('/')[3];
        console.log('ğŸ“ å½“å‰URLè·¯å¾„:', window.location.pathname);
        console.log('ğŸ“ è§£æçš„è¡¨å•ID:', formId);
        
        // éªŒè¯è¡¨å•IDæ˜¯å¦æœ‰æ•ˆ
        if (!formId || isNaN(formId)) {
            console.error('âŒ æ— æ•ˆçš„è¡¨å•ID:', formId);
            throw new Error(`æ— æ•ˆçš„è¡¨å•ID: ${formId}`);
        }
        
        // æ„å»ºè¯·æ±‚URLå’Œå‚æ•° - ä½¿ç”¨ä¸æˆåŠŸæµ‹è¯•ç›¸åŒçš„æ–¹å¼
        const params = new URLSearchParams({
            format: format,
            fileName: fileName,
            includeSubmitterInfo: includeSubmitterInfo.toString(),
            includeSubmissionTime: includeSubmissionTime.toString(),
            includeFormData: includeFormData.toString(),
            includeAttachments: includeAttachments.toString()
        });
        
        // åªæœ‰å½“statusFilterä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ 
        if (statusFilter) {
            params.append('statusFilter', statusFilter);
        }
        
        console.log('ğŸ“ å‘é€è¯·æ±‚å‚æ•°:', params.toString());
        
        // æ„å»ºå®Œæ•´çš„URL
        const exportUrl = `/admin/export/forms/${formId}?${params.toString()}`;
        console.log('ğŸ”— å®Œæ•´å¯¼å‡ºURL:', exportUrl);
        
        // æ ¹æ®æ ¼å¼ç±»å‹å¤„ç†ä¸åŒçš„ä¸‹è½½æ–¹å¼
        if (format === 'zip') {
            // ZIPæ ¼å¼éœ€è¦ç›´æ¥ä¸‹è½½ï¼Œä¸èƒ½ä½¿ç”¨fetch
            console.log('ğŸ“¦ å¼€å§‹ ZIP æ‰“åŒ…ä¸‹è½½...');
            
            // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥
            const downloadLink = document.createElement('a');
            downloadLink.href = exportUrl;
            downloadLink.style.display = 'none';
            downloadLink.download = ''; // è®©æµè§ˆå™¨è‡ªåŠ¨ç¡®å®šæ–‡ä»¶å
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            showToast('ğŸ“¦ ZIPæ‰“åŒ…æ­£åœ¨å‡†å¤‡ä¸­ï¼ŒåŒ…å«æ‰€æœ‰é™„ä»¶æ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
            return; // ZIPæ ¼å¼ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œä¸‹é¢çš„ä»£ç 
        } else {
            // Excelå’ŒCSVæ ¼å¼ä¹Ÿä½¿ç”¨è‡ªåŠ¨ä¸‹è½½
            console.log(`ğŸ“Š å¼€å§‹ ${format === 'excel' ? 'Excel' : 'CSV'} è‡ªåŠ¨ä¸‹è½½...`);
            
            // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥
            const downloadLink = document.createElement('a');
            downloadLink.href = exportUrl;
            downloadLink.style.display = 'none';
            downloadLink.download = ''; // è®©æµè§ˆå™¨è‡ªåŠ¨ç¡®å®šæ–‡ä»¶å
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            const formatText = format === 'excel' ? 'Excel' : 'CSV';
            showToast(`ğŸ“Š ${formatText}æ–‡ä»¶æ­£åœ¨å‡†å¤‡ä¸­ï¼Œè¯·ç¨å€™...`, 'info');
            return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œä¸‹é¢çš„æ‰‹åŠ¨ä¸‹è½½ä»£ç 
        }
        
        
    } catch (error) {
        console.error('âŒ å¯¼å‡ºé”™è¯¯:', error);
        showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

// å¯¼å‡ºæ•°æ®ä¸ºExcelæ ¼å¼
function exportData() {
    try {
        console.log('å¼€å§‹å¯¼å‡ºè¡¨å•æäº¤æ•°æ®ä¸ºExcelæ ¼å¼...');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å¯¼å‡ºExcelä¸­...';
        btn.disabled = true;
        
        // è·å–è¡¨å•ID
        const formId = window.location.pathname.split('/')[3];
        
        // ä½¿ç”¨fetchè·å–Excelæ•°æ®å¹¶ä¸‹è½½
        fetch(`/admin/export/forms/${formId}`, {
            method: 'GET',
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('å“åº”çŠ¶æ€:', response.status);
            console.log('å“åº”å¤´:', response.headers.get('content-type'));
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // æ£€æŸ¥å“åº”ç±»å‹
            const contentType = response.headers.get('content-type');
            console.log('å“åº”ç±»å‹:', contentType);
            
            if (contentType && contentType.includes('application/json')) {
                // å¦‚æœæ˜¯JSONå“åº”ï¼Œè¯´æ˜å¯èƒ½æœ‰é”™è¯¯
                return response.json().then(data => {
                    throw new Error(data.error || 'æœåŠ¡å™¨è¿”å›JSONå“åº”');
                });
            }
            
            return response.blob();
        })
        .then(blob => {
            console.log('Excelæ•°æ®å¤§å°:', blob.size, 'bytes');
            
            if (blob.size === 0) {
                throw new Error('æ¥æ”¶åˆ°ç©ºæ–‡ä»¶');
            }
            
            // åˆ›å»ºExcelä¸‹è½½é“¾æ¥
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `form_submissions_${formId}_${new Date().toISOString().slice(0,19).replace(/[-:]/g, '').replace('T', '_')}.xlsx`;
            document.body.appendChild(a);
            
            console.log('å¼€å§‹ä¸‹è½½Excelæ–‡ä»¶...');
            a.click();
            
            // æ¸…ç†èµ„æº
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 100);
            
            showToast('è¡¨å•æ•°æ®Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸ', 'success');
        })
        .catch(error => {
            console.error('å¯¼å‡ºExcelé”™è¯¯:', error);
            showToast(`Excelå¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
        
    } catch (error) {
        console.error('å¯¼å‡ºExcelé”™è¯¯:', error);
        showToast('Excelå¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const btn = event.target;
        btn.innerHTML = '<i class="fas fa-download me-2"></i>å¯¼å‡ºæ•°æ®';
        btn.disabled = false;
    }
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close ms-2" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

// ğŸ¯ ç®€å•ç›´æ¥çš„ä¸‹è½½å‡½æ•° - æœ€å¯é çš„æ–¹å¼
function directDownload(url, fileName) {
    console.log('ğŸš€ ä½¿ç”¨ç®€å•ç›´æ¥ä¸‹è½½æ–¹å¼:', url);
    
    // åˆ›å»ºä¸´æ—¶é“¾æ¥å¹¶è‡ªåŠ¨ç‚¹å‡»
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.style.display = 'none';
    
    // æ·»åŠ åˆ°é¡µé¢å¹¶è§¦å‘ç‚¹å‡»
    document.body.appendChild(link);
    link.click();
    
    // ç«‹å³æ¸…ç†
    setTimeout(() => {
        if (document.body.contains(link)) {
            document.body.removeChild(link);
        }
    }, 100);
    
    console.log('âœ… ç›´æ¥ä¸‹è½½å·²è§¦å‘');
    showToast('âœ… ä¸‹è½½å·²å¼€å§‹ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨ä¸‹è½½æ ï¼', 'success');
}
function downloadFile(url, fileName) {
    console.log('ğŸš€ å¼€å§‹ä¸‹è½½æ–‡ä»¶:', url);
    
    // æ–¹æ³•1: ä¼˜å…ˆå°è¯• fetch + blob ä¸‹è½½ï¼ˆé€‚ç”¨äºå¤§æ–‡ä»¶ï¼‰
    fetch(url, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv,application/octet-stream'
        }
    })
    .then(response => {
        console.log('ğŸ“¦ å“åº”çŠ¶æ€:', response.status);
        console.log('ğŸ“¦ å†…å®¹ç±»å‹:', response.headers.get('content-type'));
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.blob();
    })
    .then(blob => {
        console.log('ğŸ“¦ æ–‡ä»¶å¤§å°:', blob.size, 'bytes');
        
        if (blob.size === 0) {
            throw new Error('æ¥æ”¶åˆ°ç©ºæ–‡ä»¶');
        }
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = downloadUrl;
        a.download = fileName;
        
        // æ·»åŠ åˆ°é¡µé¢å¹¶è§¦å‘ä¸‹è½½
        document.body.appendChild(a);
        console.log('ğŸš€ è§¦å‘ä¸‹è½½:', fileName);
        a.click();
        
        // æ¸…ç†èµ„æº
        setTimeout(() => {
            window.URL.revokeObjectURL(downloadUrl);
            if (document.body.contains(a)) {
                document.body.removeChild(a);
            }
        }, 1000);
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showToast('âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼', 'success');
        
        // å…³é—­ä¸‹è½½æç¤ºæ¡†
        setTimeout(() => {
            const downloadNotice = document.querySelector('.alert.alert-success.position-fixed');
            if (downloadNotice) {
                downloadNotice.style.opacity = '0';
                downloadNotice.style.transform = 'translateX(100%)';
                setTimeout(() => downloadNotice.remove(), 300);
            }
        }, 2000);
        
    })
    .catch(error => {
        console.error('âŒ fetchä¸‹è½½å¤±è´¥:', error);
        
        // å¦‚æœfetchå¤±è´¥ï¼Œåˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        console.log('ğŸ”„ å°è¯•å¤‡ç”¨ä¸‹è½½æ–¹æ¡ˆ...');
        
        // æ–¹æ³•2: ä½¿ç”¨ window.open
        try {
            const newWindow = window.open(url, '_blank');
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                // å¼¹çª—è¢«é˜»æ­¢ï¼Œä½¿ç”¨ç›´æ¥è·³è½¬
                console.log('ğŸ”„ å¼¹çª—è¢«é˜»æ­¢ï¼Œä½¿ç”¨ç›´æ¥è·³è½¬...');
                window.location.href = url;
            } else {
                console.log('âœ… æ–°çª—å£ä¸‹è½½å·²å¯åŠ¨');
                // 3ç§’åå…³é—­æ–°çª—å£
                setTimeout(() => {
                    if (!newWindow.closed) {
                        newWindow.close();
                    }
                }, 3000);
            }
        } catch (openError) {
            console.error('âŒ window.openå¤±è´¥:', openError);
            showToast(`ä¸‹è½½å¤±è´¥: ${error.message}. è¯·å°è¯•ç›´æ¥ç‚¹å‡»é“¾æ¥ã€‚`, 'error');
        }
    });
}

// å¤åˆ¶ä¸‹è½½é“¾æ¥åˆ°å‰ªè´´æ¿
function copyDownloadLink(url) {
    const fullUrl = window.location.origin + url;
    
    if (navigator.clipboard && window.isSecureContext) {
        // ä½¿ç”¨ç°ä»£ Clipboard API
        navigator.clipboard.writeText(fullUrl).then(() => {
            showToast('âœ… ä¸‹è½½é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            fallbackCopyTextToClipboard(fullUrl);
        });
    } else {
        // å¤‡ç”¨æ–¹æ¡ˆ
        fallbackCopyTextToClipboard(fullUrl);
    }
}

// å¤‡ç”¨å¤åˆ¶æ–¹æ³•
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.top = '-9999px';
    textArea.style.left = '-9999px';
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showToast('âœ… ä¸‹è½½é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
        } else {
            showToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥', 'error');
        }
    } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥', 'error');
    }
    
    document.body.removeChild(textArea);
}
</script>

<!-- å¯¼å‡ºé€‰é¡¹æ¨¡æ€æ¡† -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="fas fa-download me-2"></i>å¯¼å‡º{{ form.title }}æäº¤æ•°æ®
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportFormSubmissions">
                    <!-- æ–‡ä»¶åè®¾ç½® -->
                    <div class="mb-3">
                        <label for="submissionFileName" class="form-label">
                            <i class="fas fa-file me-1"></i>æ–‡ä»¶å
                        </label>
                        <input type="text" class="form-control" id="submissionFileName" 
                               value="{{ form.title }}_submissions" placeholder="è¯·è¾“å…¥æ–‡ä»¶å">
                        <div class="form-text">ä¸éœ€è¦åŒ…å«æ‰©å±•åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ </div>
                    </div>
                    
                    <!-- å¯¼å‡ºæ ¼å¼é€‰æ‹© -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-file-export me-1"></i>å¯¼å‡ºæ ¼å¼
                        </label>
                        <div class="row">
                            <div class="col-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="submissionExportFormat" 
                                           id="submissionFormatExcel" value="excel" checked>
                                    <label class="form-check-label" for="submissionFormatExcel">
                                        <i class="fas fa-file-excel text-success me-1"></i>Excel æ–‡ä»¶
                                    </label>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="submissionExportFormat" 
                                           id="submissionFormatCsv" value="csv">
                                    <label class="form-check-label" for="submissionFormatCsv">
                                        <i class="fas fa-file-csv text-primary me-1"></i>CSV æ–‡ä»¶
                                    </label>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="submissionExportFormat" 
                                           id="submissionFormatZip" value="zip">
                                    <label class="form-check-label" for="submissionFormatZip">
                                        <i class="fas fa-file-archive text-warning me-1"></i>ZIP æ‰“åŒ…
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <i class="fas fa-info-circle me-1"></i>
                            ZIP æ‰“åŒ…ä¼šå°†å¯¼å‡ºæ•°æ®å’Œæ‰€æœ‰é™„ä»¶æ–‡ä»¶ä¸€èµ·ä¸‹è½½
                        </div>
                    </div>
                    
                    <!-- å¯¼å‡ºå†…å®¹é€‰æ‹© -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-list-check me-1"></i>å¯¼å‡ºå†…å®¹
                        </label>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeSubmitterInfo" checked>
                                    <label class="form-check-label" for="includeSubmitterInfo">
                                        æäº¤è€…ä¿¡æ¯
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeSubmissionTime" checked>
                                    <label class="form-check-label" for="includeSubmissionTime">
                                        æäº¤æ—¶é—´
                                    </label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeFormData" checked>
                                    <label class="form-check-label" for="includeFormData">
                                        è¡¨å•æ•°æ®
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeAttachments" checked>
                                    <label class="form-check-label" for="includeAttachments">
                                        é™„ä»¶ä¿¡æ¯ï¼ˆåŒ…å«ä¸‹è½½é“¾æ¥ï¼‰
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çŠ¶æ€ç­›é€‰ -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-filter me-1"></i>çŠ¶æ€ç­›é€‰
                        </label>
                        <select class="form-select" id="exportSubmissionStatusFilter">
                            <option value="">æ‰€æœ‰çŠ¶æ€</option>
                            <option value="submitted">ä»…å¾…å®¡æ ¸</option>
                            <option value="approved">ä»…å·²é€šè¿‡</option>
                            <option value="rejected">ä»…å·²æ‹’ç»</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-primary" onclick="startSubmissionExport()">
                    <i class="fas fa-download me-1"></i>å¼€å§‹å¯¼å‡º
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-danger" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>ç¡®è®¤åˆ é™¤
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="alert alert-warning border-0 bg-light">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>åˆ é™¤æ“ä½œæ— æ³•æ’¤é”€ï¼</strong>ç›¸å…³çš„ä¸Šä¼ æ–‡ä»¶ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤ã€‚
                </div>
                <p class="mb-0" id="deleteConfirmText">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæäº¤è®°å½•å—ï¼Ÿ</p>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
