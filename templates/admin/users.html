{% extends "base.html" %}

{% block title %}用户管理 - 信息收集系统{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h2 class="mb-1">用户管理</h2>
                    <p class="text-muted mb-0">管理系统中的所有注册用户</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                        <i class="fas fa-download me-2"></i>导出用户数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-primary mb-2">
                        <i class="fas fa-users text-white"></i>
                    </div>
                    <h4 class="fw-bold text-primary">{{ users|length }}</h4>
                    <p class="text-muted mb-0">总用户数</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-success mb-2">
                        <i class="fas fa-user-check text-white"></i>
                    </div>
                    <h4 class="fw-bold text-success">{{ users|selectattr('is_active', 'equalto', true)|list|length }}</h4>
                    <p class="text-muted mb-0">活跃用户</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-info mb-2">
                        <i class="fas fa-envelope text-white"></i>
                    </div>
                    <h4 class="fw-bold text-info">{{ users|selectattr('email', 'defined')|list|length }}</h4>
                    <p class="text-muted mb-0">邮箱注册</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-warning mb-2">
                        <i class="fas fa-mobile-alt text-white"></i>
                    </div>
                    <h4 class="fw-bold text-warning">{{ users|selectattr('phone', 'defined')|list|length }}</h4>
                    <p class="text-muted mb-0">手机注册</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户列表 -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-list me-2"></i>用户列表
                </h5>
                <div class="d-flex align-items-center">
                    <!-- 批量操作按钮（默认隐藏） -->
                    <div class="batch-actions me-3" style="display: none;">
                        <div class="btn-group">
                            <button type="button" class="btn btn-success btn-sm" onclick="batchAction('activate')">
                                <i class="fas fa-user-check me-1"></i>启用 (<span class="selected-count">0</span>)
                            </button>
                            <button type="button" class="btn btn-warning btn-sm" onclick="batchAction('deactivate')">
                                <i class="fas fa-user-times me-1"></i>禁用
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="batchAction('delete')">
                                <i class="fas fa-trash me-1"></i>删除
                            </button>
                        </div>
                    </div>
                    <!-- 状态筛选 -->
                    <select class="form-select form-select-sm me-3" id="statusFilter" onchange="filterByStatus()">
                        <option value="">所有状态</option>
                        <option value="active">活跃用户</option>
                        <option value="inactive">禁用用户</option>
                    </select>
                    <!-- 注册方式筛选 -->
                    <select class="form-select form-select-sm me-3" id="typeFilter" onchange="filterByType()">
                        <option value="">所有类型</option>
                        <option value="email">邮箱注册</option>
                        <option value="phone">手机注册</option>
                    </select>
                    <!-- 搜索框 -->
                    <div class="input-group input-group-sm" style="width: 200px;">
                        <input type="text" class="form-control" placeholder="搜索用户..." id="searchInput" onkeyup="searchUsers()">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if users %}
                <div class="table-responsive">
                    <table class="table table-hover" id="usersTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 3%;">
                                    <input type="checkbox" class="form-check-input select-all" onchange="toggleSelectAll(this)">
                                </th>
                                <th style="width: 5%;">ID</th>
                                <th style="width: 15%;">姓名</th>
                                <th style="width: 20%;">联系方式</th>
                                <th style="width: 15%;">注册时间</th>
                                <th style="width: 10%;">状态</th>
                                <th style="width: 10%;">提交数</th>
                                <th style="width: 22%;">最近活动</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr data-status="{{ 'active' if user.is_active else 'inactive' }}" 
                                data-type="{{ 'email' if user.email else 'phone' }}">
                                <td>
                                    <input type="checkbox" class="form-check-input user-checkbox" 
                                           value="{{ user.id }}" onchange="updateBatchActions()">
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">#{{ user.id }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar bg-primary text-white rounded-circle me-2">
                                            {{ user.name[0].upper() }}
                                        </div>
                                        <div>
                                            <strong class="user-name">{{ user.name }}</strong>
                                            {% if not user.is_active %}
                                                <br><small class="text-danger">已禁用</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="user-contact">
                                    {% if user.email %}
                                        <div class="mb-1">
                                            <i class="fas fa-envelope text-primary me-1"></i>
                                            <span>{{ user.email }}</span>
                                        </div>
                                    {% endif %}
                                    {% if user.phone %}
                                        <div class="mb-1">
                                            <i class="fas fa-phone text-success me-1"></i>
                                            <span>{{ user.phone }}</span>
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-muted">{{ user.created_at | local_date }}</span>
                                    <br><small class="text-muted">{{ user.created_at | local_time('%H:%M:%S') }}</small>
                                </td>
                                <td>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" 
                                               {% if user.is_active %}checked{% endif %}
                                               onchange="toggleUserStatus({{ user.id }}, this)">
                                        <label class="form-check-label">
                                            <small class="status-text">
                                                {% if user.is_active %}活跃{% else %}禁用{% endif %}
                                            </small>
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ user.submissions|length }}</span>
                                    {% if user.submissions %}
                                        {% set latest_submission = user.submissions|sort(attribute='submitted_at', reverse=true)|first %}
                                        <br><small class="text-muted">
                                            最近: {{ latest_submission.submitted_at | local_time_short }}
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.submissions %}
                                        {% set latest_submission = user.submissions|sort(attribute='submitted_at', reverse=true)|first %}
                                        <small class="text-muted">
                                            <strong>{{ latest_submission.form.title }}</strong><br>
                                            {{ latest_submission.submitted_at | local_time }}
                                        </small>
                                    {% else %}
                                        <small class="text-muted">无活动记录</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-user-plus text-muted" style="font-size: 4rem;"></i>
                    <h5 class="text-muted mt-3">暂无注册用户</h5>
                    <p class="text-muted">当用户注册账号后，信息将在这里显示</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin: 0 auto;
}

.user-avatar {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: bold;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
    vertical-align: middle;
}

.table td {
    vertical-align: middle;
}

.form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.badge {
    font-size: 0.75rem;
}

.user-contact i {
    width: 16px;
}
</style>

<script>
// 按状态筛选
function filterByStatus() {
    const filter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        if (filter === '' || status === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// 按注册类型筛选
function filterByType() {
    const filter = document.getElementById('typeFilter').value;
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const type = row.getAttribute('data-type');
        if (filter === '' || type === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// 搜索用户
function searchUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const userName = row.querySelector('.user-name').textContent.toLowerCase();
        const userContact = row.querySelector('.user-contact').textContent.toLowerCase();
        
        if (userName.includes(searchTerm) || userContact.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// 切换全选
function toggleSelectAll(checkbox) {
    const userCheckboxes = document.querySelectorAll('.user-checkbox');
    userCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateBatchActions();
}

// 更新批量操作按钮显示
function updateBatchActions() {
    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
    const batchActions = document.querySelector('.batch-actions');
    const selectedCount = document.querySelector('.selected-count');
    
    if (selectedCheckboxes.length > 0) {
        batchActions.style.display = 'block';
        selectedCount.textContent = selectedCheckboxes.length;
    } else {
        batchActions.style.display = 'none';
    }
    
    // 更新全选复选框状态
    const selectAllCheckbox = document.querySelector('.select-all');
    const allCheckboxes = document.querySelectorAll('.user-checkbox');
    const allChecked = allCheckboxes.length > 0 && [...allCheckboxes].every(cb => cb.checked);
    const someChecked = [...allCheckboxes].some(cb => cb.checked);
    
    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = someChecked && !allChecked;
}

// 执行批量操作
function batchAction(action) {
    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
    const userIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
    
    if (userIds.length === 0) {
        showToast('请选择要操作的用户', 'warning');
        return;
    }
    
    let actionText = '';
    let confirmMessage = '';
    
    switch(action) {
        case 'activate':
            actionText = '启用';
            confirmMessage = `确定要启用这 ${userIds.length} 个用户吗？`;
            break;
        case 'deactivate':
            actionText = '禁用';
            confirmMessage = `确定要禁用这 ${userIds.length} 个用户吗？`;
            break;
        case 'delete':
            actionText = '删除';
            confirmMessage = `警告：删除用户将一同删除他们的所有提交记录。\n确定要删除这 ${userIds.length} 个用户吗？`;
            break;
        default:
            return;
    }
    
    if (confirm(confirmMessage)) {
        // 显示加载状态
        const batchButtons = document.querySelectorAll('.batch-actions button');
        batchButtons.forEach(btn => {
            btn.disabled = true;
            if (btn.onclick.toString().includes(action)) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>处理中...';
            }
        });
        
        // 发送批量操作请求
        fetch('/admin/users/batch-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: action,
                user_ids: userIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                
                // 根据操作类型更新页面
                if (action === 'delete') {
                    // 删除操作：移除表格行
                    selectedCheckboxes.forEach(cb => {
                        cb.closest('tr').remove();
                    });
                } else if (action === 'activate' || action === 'deactivate') {
                    // 状态更新：更新状态显示
                    const isActive = action === 'activate';
                    selectedCheckboxes.forEach(cb => {
                        const row = cb.closest('tr');
                        const statusSwitch = row.querySelector('.form-check-input[type="checkbox"][onchange*="toggleUserStatus"]');
                        const statusText = row.querySelector('.status-text');
                        
                        if (statusSwitch && statusText) {
                            statusSwitch.checked = isActive;
                            statusText.textContent = isActive ? '活跃' : '禁用';
                            row.setAttribute('data-status', isActive ? 'active' : 'inactive');
                        }
                    });
                }
                
                // 清除选中状态
                document.querySelector('.select-all').checked = false;
                selectedCheckboxes.forEach(cb => cb.checked = false);
                updateBatchActions();
                
            } else {
                throw new Error(data.error || '操作失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast(error.message || `${actionText}失败，请重试`, 'error');
        })
        .finally(() => {
            // 恢复按钮状态
            batchButtons.forEach(btn => {
                btn.disabled = false;
                const iconHtml = btn.querySelector('i');
                if (btn.onclick.toString().includes('activate')) {
                    btn.innerHTML = '<i class="fas fa-user-check me-1"></i>启用 (<span class="selected-count">0</span>)';
                } else if (btn.onclick.toString().includes('deactivate')) {
                    btn.innerHTML = '<i class="fas fa-user-times me-1"></i>禁用';
                } else if (btn.onclick.toString().includes('delete')) {
                    btn.innerHTML = '<i class="fas fa-trash me-1"></i>删除';
                }
            });
        });
    }
}

// 切换用户状态
function toggleUserStatus(userId, checkbox) {
    const statusText = checkbox.closest('td').querySelector('.status-text');
    const userName = checkbox.closest('tr').querySelector('.user-name').textContent;
    
    const action = checkbox.checked ? '启用' : '禁用';
    if (confirm(`确定要${action}用户 "${userName}" 吗？`)) {
        // 显示加载状态
        checkbox.disabled = true;
        
        // 发送请求到后端更新状态
        fetch(`/admin/users/${userId}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusText.textContent = data.is_active ? '活跃' : '禁用';
                showToast(data.message, 'success');
            } else {
                throw new Error(data.error || '状态更新失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // 恢复开关状态
            checkbox.checked = !checkbox.checked;
            showToast(error.message || '状态更新失败，请重试', 'error');
        })
        .finally(() => {
            checkbox.disabled = false;
        });
    } else {
        // 恢复开关状态
        checkbox.checked = !checkbox.checked;
    }
}

// 按状态筛选用户
function filterByStatus() {
    const filter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        if (filter === '' || status === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // 重置选中状态
    clearAllSelections();
}

// 按注册类型筛选用户
function filterByType() {
    const filter = document.getElementById('typeFilter').value;
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const type = row.getAttribute('data-type');
        if (filter === '' || type === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // 重置选中状态
    clearAllSelections();
}

// 搜索用户
function searchUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const userName = row.querySelector('.user-name').textContent.toLowerCase();
        const userContact = row.querySelector('.user-contact').textContent.toLowerCase();
        
        if (userName.includes(searchTerm) || userContact.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // 重置选中状态
    clearAllSelections();
}

// 清除所有选中状态
function clearAllSelections() {
    document.querySelector('.select-all').checked = false;
    document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
    updateBatchActions();
}

// 新的导出函数，支持可选保存位置和格式
function startExport() {
    try {
        // 获取表单数据
        const fileName = document.getElementById('fileName').value.trim() || 'users_data';
        const format = document.querySelector('input[name="exportFormat"]:checked').value;
        
        // 获取导出内容选项
        const includeBasicInfo = document.getElementById('includeBasicInfo').checked;
        const includeContactInfo = document.getElementById('includeContactInfo').checked;
        const includeSubmissions = document.getElementById('includeSubmissions').checked;
        const includeActivity = document.getElementById('includeActivity').checked;
        
        // 获取筛选选项
        const statusFilter = document.getElementById('exportStatusFilter').value;
        const typeFilter = document.getElementById('exportTypeFilter').value;
        
        console.log('开始导出用户数据...', { fileName, format, statusFilter, typeFilter });
        
        // 关闭模态框 - 使用更安全的方式
        try {
            const modalElement = document.getElementById('exportModal');
            if (modalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                } else {
                    // 如果实例不存在，直接隐藏模态框
                    modalElement.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                }
            }
        } catch (modalError) {
            console.warn('关闭模态框时出错:', modalError);
        }
        
        // 显示加载状态的Toast
        showToast('正在准备导出数据，请稍候...', 'info');
        
        // 构建请求URL和参数
        const params = new URLSearchParams({
            format: format,
            fileName: fileName,
            includeBasicInfo: includeBasicInfo,
            includeContactInfo: includeContactInfo,
            includeSubmissions: includeSubmissions,
            includeActivity: includeActivity,
            statusFilter: statusFilter,
            typeFilter: typeFilter
        });
        
        console.log('发送请求参数:', params.toString());
        
        // 使用fetch获取数据并下载
        fetch(`/admin/export/users?${params.toString()}`, {
            method: 'GET',
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('响应状态:', response.status);
            console.log('响应头:', response.headers.get('content-type'));
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // 检查响应类型
            const contentType = response.headers.get('content-type');
            console.log('响应类型:', contentType);
            
            if (contentType && contentType.includes('application/json')) {
                // 如果是JSON响应，说明可能有错误
                return response.json().then(data => {
                    throw new Error(data.error || '服务器返回JSON响应');
                });
            }
            
            return response.blob();
        })
        .then(blob => {
            console.log('数据大小:', blob.size, 'bytes');
            
            if (blob.size === 0) {
                throw new Error('接收到空文件');
            }
            
            // 根据格式决定文件扩展名
            const extension = format === 'excel' ? '.xlsx' : '.csv';
            const timestamp = new Date().toISOString().slice(0,19).replace(/[-:]/g, '').replace('T', '_');
            const finalFileName = `${fileName}_${timestamp}${extension}`;
            
            // 创建下载链接
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = finalFileName;
            document.body.appendChild(a);
            
            console.log('开始下载文件:', finalFileName);
            a.click();
            
            // 清理资源
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 100);
            
            const formatText = format === 'excel' ? 'Excel' : 'CSV';
            showToast(`用户数据${formatText}文件导出成功`, 'success');
        })
        .catch(error => {
            console.error('导出错误:', error);
            showToast(`导出失败: ${error.message}`, 'error');
        });
        
    } catch (error) {
        console.error('导出错误:', error);
        showToast('导出失败，请重试', 'error');
    }
}

// 保留原有的exportUsers函数作为备用
function exportUsers() {
    try {
        console.log('开始导出Excel格式用户数据...');
        
        // 显示加载状态
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>导出Excel中...';
        btn.disabled = true;
        
        // 使用fetch获取Excel数据并下载
        fetch('/admin/export/users', {
            method: 'GET',
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('响应状态:', response.status);
            console.log('响应头:', response.headers.get('content-type'));
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // 检查响应类型
            const contentType = response.headers.get('content-type');
            console.log('响应类型:', contentType);
            
            if (contentType && contentType.includes('application/json')) {
                // 如果是JSON响应，说明可能有错误
                return response.json().then(data => {
                    throw new Error(data.error || '服务器返回JSON响应');
                });
            }
            
            return response.blob();
        })
        .then(blob => {
            console.log('Excel数据大小:', blob.size, 'bytes');
            
            if (blob.size === 0) {
                throw new Error('接收到空文件');
            }
            
            // 创建Excel下载链接
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `users_data_${new Date().toISOString().slice(0,19).replace(/[-:]/g, '').replace('T', '_')}.xlsx`;
            document.body.appendChild(a);
            
            console.log('开始下载Excel文件...');
            a.click();
            
            // 清理资源
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 100);
            
            showToast('用户数据Excel文件导出成功', 'success');
        })
        .catch(error => {
            console.error('导出Excel错误:', error);
            showToast(`Excel导出失败: ${error.message}`, 'error');
        })
        .finally(() => {
            // 恢复按钮状态
            if (event && event.target) {
                const btn = event.target;
                btn.innerHTML = '<i class="fas fa-download me-2"></i>导出Excel';
                btn.disabled = false;
            }
        });
        
    } catch (error) {
        console.error('导出Excel错误:', error);
        showToast('Excel导出失败，请重试', 'error');
        
        // 恢复按钮状态
        if (event && event.target) {
            const btn = event.target;
            btn.innerHTML = '<i class="fas fa-download me-2"></i>导出Excel';
            btn.disabled = false;
        }
    }
}

// 显示提示消息
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close ms-2" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}
</script>

<!-- 导出选项模态框 -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="fas fa-download me-2"></i>导出用户数据
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <!-- 文件名设置 -->
                    <div class="mb-3">
                        <label for="fileName" class="form-label">
                            <i class="fas fa-file me-1"></i>文件名
                        </label>
                        <input type="text" class="form-control" id="fileName" 
                               value="users_data" placeholder="请输入文件名">
                        <div class="form-text">不需要包含扩展名，系统会自动添加</div>
                    </div>
                    
                    <!-- 导出格式选择 -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-file-export me-1"></i>导出格式
                        </label>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="exportFormat" 
                                           id="formatExcel" value="excel" checked>
                                    <label class="form-check-label" for="formatExcel">
                                        <i class="fas fa-file-excel text-success me-1"></i>Excel 文件 (.xlsx)
                                    </label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="exportFormat" 
                                           id="formatCsv" value="csv">
                                    <label class="form-check-label" for="formatCsv">
                                        <i class="fas fa-file-csv text-primary me-1"></i>CSV 文件 (.csv)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 导出内容选择 -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-list-check me-1"></i>导出内容
                        </label>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeBasicInfo" checked>
                                    <label class="form-check-label" for="includeBasicInfo">
                                        基本信息
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeContactInfo" checked>
                                    <label class="form-check-label" for="includeContactInfo">
                                        联系方式
                                    </label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeSubmissions" checked>
                                    <label class="form-check-label" for="includeSubmissions">
                                        提交统计
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeActivity" checked>
                                    <label class="form-check-label" for="includeActivity">
                                        活动记录
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 用户筛选 -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-filter me-1"></i>用户筛选
                        </label>
                        <div class="row">
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="exportStatusFilter">
                                    <option value="">所有状态</option>
                                    <option value="active">仅活跃用户</option>
                                    <option value="inactive">仅禁用用户</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="exportTypeFilter">
                                    <option value="">所有类型</option>
                                    <option value="email">仅邮箱注册</option>
                                    <option value="phone">仅手机注册</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-primary" onclick="startExport()">
                    <i class="fas fa-download me-1"></i>开始导出
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
